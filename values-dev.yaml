# Development Environment Configuration
# 2-node cluster with reduced resources

global:
  namespace: webmethods

# Cluster label for multi-cluster monitoring within same namespace
# Used by Prometheus ServiceMonitors and Grafana dashboards to differentiate clusters
clusterLabel: "dev"

replicaCount: 2

image:
  repository: abiwebmethods.azurecr.io/webmethods-microservicesruntime
  tag: "11.1.0.6-dev"
  pullPolicy: Always

service:
  type: ClusterIP
  ports:
    http: 5555
    https: 5543
    diagnostic: 9999

# Resources for dev
resources:
  requests:
    memory: "1Gi"
    cpu: "1000m"
  limits:
    memory: "1Gi"
    cpu: "1000m"

# JVM memory for dev
jvm:
  minMemory: "800m"
  maxMemory: "900m"

# ============================================================================
# Security Context - Development Environment
# ============================================================================
# Uses sagadmin (UID=1724) as standard non-root identity per IBM/SoftwareAG best practices.
# Init container (copy-keyvault-keystores) runs as root with minimal capabilities.
# readOnlyRootFilesystem is NOT enabled - postStart hooks write to container root FS.
# ============================================================================
securityContext:
  pod:
    fsGroup: 1724
    runAsUser: 1724
    runAsGroup: 1724
    runAsNonRoot: true
    fsGroupChangePolicy: "OnRootMismatch"
  container:
    runAsUser: 1724
    runAsGroup: 1724
    runAsNonRoot: true
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL

# ============================================================================
# Logging Configuration - Development Environment
# ============================================================================
# For development, use "Info" level by default. Switch to "Trace" for debugging.
# IMPORTANT: Trace level generates significant log volume and impacts performance
#
# To enable TRACE logging for debugging:
#   helm upgrade wm-msr ./msr-helm -f values-dev.yaml \
#     --set logging.level=Trace \
#     --set logging.sap.level=6 \
#     --set logging.sap.jcoTraceLevel=8
# ============================================================================
logging:
  # General IS debug level (Off, Fatal, Error, Warn, Info, Debug, Trace)
  level: "Info"

  # Enable verbose server logging (helpful for debugging)
  verbose: false

  # Enable service audit logging
  auditLog: false

  # Enable detailed thread logging
  threadDump: false

  # JDBC logging
  jdbc:
    enabled: false
    level: "Info"

  # SAP Adapter logging configuration
  # Levels: 0=Off, 1=Fatal, 2=Error, 3=Warn, 4=Info, 5=Debug, 6=Trace
  sap:
    # SAP adapter internal log level (0-6, where 6=Trace)
    level: 4  # Default to Info (4)
    # JCo trace level (0-10, where 0=off, 10=most verbose)
    # Set to 8 for detailed SAP communication tracing
    jcoTraceLevel: 0  # Default to off
    # JCo trace output path
    jcoTracePath: "/opt/softwareag/IntegrationServer/instances/default/logs"
    # Facility-specific logging for SAP (format: facility:level)
    # Example: "SAP*:6,SCC*:6" for TRACE on all SAP facilities
    facilities: ""

  # Spring Boot / SLF4J logging (for MSR components using Spring)
  spring:
    enabled: false  # Set to true to enable Spring Boot logging config
    rootLevel: "INFO"
    # Component-specific levels (only applied when spring.enabled=true)
    components:
      wm: "INFO"
      softwareag: "INFO"
      sapAdapter: "INFO"
      jco: "INFO"

# Persistence
persistence:
  enabled: true
  storageClass: "default"
  accessMode: ReadWriteOnce
  size: 3Gi

# ============================================================================
# JDBC POOL Configuration (MSR Internal Database for ISInternal, Xref, etc.)
# ============================================================================
# JDBC Pools are used by MSR internal functions like ISInternal, ISDashboardStats, Xref
# Multiple pools can be configured. Each pool requires:
#   - name: Pool name (used in application.properties)
#   - dbURL: JDBC connection URL (in values file - not sensitive)
#   - username: Database username (in values file - not sensitive)
#   - secretName: Azure Key Vault secret name for password (password only from KV)
#   - passwordEnvVar: Environment variable name for password injection
#
# Pool sizing configuration is environment-specific and non-sensitive
# ============================================================================
jdbcPool:
  enabled: true
  pools:
    # Primary pool for ISInternal, Xref, Dashboard
    - name: "IS-Pool"
      description: "MSR Internal JDBC Pool"
      dbURL: "jdbc:wm:sqlserver://wm-sql-abi-dev.database.windows.net:1433;databaseName=isinternal"
      username: "wmadmin"
      secretName: "jdbcpool-ispool-password"     # Key Vault: dev-jdbcpool-ispool-password
      passwordEnvVar: "JDBC_IS_POOL_PASSWORD"
      driverAlias: "DataDirect Connect JDBC SQL Server Driver"
      dataSourceClass: "com.wm.dd.jdbc.sqlserver.SQLServerDataSource"
      minConns: 1
      maxConns: 100
      poolThreshold: 5
      waitingThread: 50
      expireTime: 60000
      useSSL: false

    # Example: Additional pool for custom application database
    # - name: "App-Pool"
    #   description: "Custom Application JDBC Pool"
    #   dbURL: "jdbc:wm:sqlserver://app-sql-dev.database.windows.net:1433;databaseName=APP_DEV"
    #   username: "app_user"
    #   secretName: "jdbcpool-apppool-password"  # Key Vault: dev-jdbcpool-apppool-password
    #   passwordEnvVar: "JDBC_APP_POOL_PASSWORD"
    #   driverAlias: "DataDirect Connect JDBC SQL Server Driver"
    #   dataSourceClass: "com.wm.dd.jdbc.sqlserver.SQLServerDataSource"
    #   minConns: 1
    #   maxConns: 50
    #   poolThreshold: 5
    #   waitingThread: 25
    #   expireTime: 60000
    #   useSSL: true

  # JDBC Functional Aliases map logical names to physical pool names
  functionalAliases:
    - name: "ISInternal"
      connPoolAlias: "IS-Pool"
      failFastMode: true
    - name: "ISDashboardStats"
      connPoolAlias: "IS-Pool"
      failFastMode: false
    - name: "Xref"
      connPoolAlias: "IS-Pool"
      failFastMode: true

# ============================================================================
# JDBC ADAPTER Configuration
# ============================================================================
# JDBC Adapter connections are configured in a separate file for maintainability.
# See: adapters/values-jdbc-adapter-dev.yaml
#
# Usage:
#   helm upgrade --install wm-msr ./msr-helm \
#     -f values-dev.yaml \
#     -f adapters/values-jdbc-adapter-dev.yaml \
#     -n webmethods
# ============================================================================

# ============================================================================
# SAP ADAPTER Configuration
# ============================================================================
# SAP Adapter connections and listeners are configured in a separate file.
# See: adapters/values-sap-adapter-dev.yaml
#
# Usage:
#   helm upgrade --install wm-msr ./msr-helm \
#     -f values-dev.yaml \
#     -f adapters/values-sap-adapter-dev.yaml \
#     -n webmethods
# ============================================================================

# High availability with pod anti-affinity
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          topologyKey: kubernetes.io/hostname
          labelSelector:
            matchLabels:
              app: wm-msr

# Pod Disruption Budget
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Health Probes (faster for dev)
healthProbes:
  startup:
    enabled: true
    path: /
    port: 5555
    initialDelaySeconds: 60
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 30
  liveness:
    enabled: true
    path: /
    port: 5555
    initialDelaySeconds: 120
    periodSeconds: 30
    timeoutSeconds: 10
    failureThreshold: 3
  readiness:
    enabled: true
    path: /
    port: 5555
    initialDelaySeconds: 60
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

# Universal Messaging Configuration
# Passwords stored in Azure Key Vault: dev-um-business-password, dev-um-logs-password
um:
  enabled: true
  connections:
    # Business UM Connection (Active-Passive Cluster)
    - connectionAlias: "IS_UM_BUSINESS"
      connectionEnabled: true
      url: "nsp://um-business.webmethods.svc.cluster.local:9000"
      user: "Administrator"
      useCSQ: "true"
      csqSize: "-1"
      csqDrainInOrder: "true"
      secretName: "um-business-password"
      passwordEnvVar: "UM_BUSINESS_PASSWORD"
    # Logs UM Connection (Active-Active Cluster - Combined Service)
    - connectionAlias: "IS_UM_LOGS"
      connectionEnabled: true
      url: "nsp://um-logs-combined.webmethods.svc.cluster.local:9000"
      user: "Administrator"
      useCSQ: "true"
      csqSize: "-1"
      csqDrainInOrder: "true"
      secretName: "um-logs-password"
      passwordEnvVar: "UM_LOGS_PASSWORD"

# =====================
# CACHING CONFIGURATION
# =====================
# Public Cache Managers loaded from files/config/caching/*.xml
# Each XML defines an Ehcache cache manager with named caches
# Included: OrderCache (ActiveOrders, OrderHistory),
#           SessionCache (UserSessions, AuthTokens),
#           LookupCache (CountryCodes, CurrencyRates, ProductCatalog)
caching:
  publicCacheManagers:
    enabled: true

# Terracotta Cache Manager Configuration
terracotta:
  enabled: false
  cacheManagerName: "IS_TERRACOTTA_CACHE"
  urls:
    - "terracotta-0.terracotta-service.webmethods.svc.cluster.local:9510"
    - "terracotta-1.terracotta-service.webmethods.svc.cluster.local:9510"
  # Only 2 Terracotta servers are deployed, matching StatefulSet replicas

# Keystore Configuration (example - no actual files mounted in dev)
# To use actual keystore files, add 'fileData' field with base64 encoded content
keystores: []
  # - aliasName: "DEFAULT_IS_KEYSTORE"
  #   description: "Default Integration Server Keystore for SSL/TLS"
  #   type: "PKCS12"
  #   provider: "SUN"
  #   location: "/opt/softwareag/IntegrationServer/config/security/keystore.p12"
  #   password: "manage"
  #   isHsm: false
  #   keys:
  #     - keyAliasName: "sslkey"
  #       keyAliasPassword: "manage"
  #   # fileData: ""  # Base64 encoded keystore file

# Truststore Configuration (example - no actual files mounted in dev)
truststores: []
  # - aliasName: "DEFAULT_IS_TRUSTSTORE"
  #   description: "Default Integration Server Truststore for SSL/TLS"
  #   type: "JKS"
  #   provider: "SUN"
  #   location: "/opt/softwareag/IntegrationServer/config/security/truststore.jks"
  #   password: "manage"
  #   # fileData: ""  # Base64 encoded truststore file

# Autoscaling Configuration
autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 5
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# ============================================================================
# Azure Key Vault Integration
# ============================================================================
# Store certificates in Azure Key Vault for centralized management
# Two types of certificates can be stored:
#
# 1. KEYSTORE Certificate (Certificate + Private Key)
#    - Used for YOUR server's identity (SSL/TLS server certificate)
#    - Must be imported as PKCS12/PFX with private key
#    - CSI driver mounts both .crt and .key files
#    - Init container converts PEM to PKCS12 keystore
#
# 2. TRUSTSTORE Certificate (Certificate only, NO Private Key)
#    - Used for TRUSTED external parties (CA certs, partner certs)
#    - Imported as .crt, .cer, or .pem (no private key)
#    - CSI driver mounts only .crt file
#    - Init container combines multiple certs into PKCS12 truststore
#
# IMPORTANT: Azure Key Vault Access Requirements
# -----------------------------------------------
# The AKS kubelet managed identity must have access to the Key Vault.
# Use the following commands to grant access:
#
# 1. Get the kubelet identity Object ID (NOT Client ID):
#    az aks show --resource-group RG-AKS-WM-IS1 --name webmethods-cluster \
#      --query "identityProfile.kubeletidentity.objectId" -o tsv
#
# 2. Grant Key Vault access using the Object ID:
#    az keyvault set-policy --name wM-kv \
#      --object-id <OBJECT_ID_FROM_STEP_1> \
#      --secret-permissions get list \
#      --certificate-permissions get list
#
# For this cluster:
#   Kubelet Identity Client ID: 29cefdea-4779-43cd-9fb0-f9660bb69927
#   Kubelet Identity Object ID: f9cf8c80-b86f-41e0-a4fb-09110f99ec30
#   CSI Driver Identity Client ID: e08a2b12-1b21-4660-927a-63debb48df4d
#   CSI Driver Identity Object ID: 1d5658a5-58bc-4b33-a3b6-d86185299d68 (use this for Key Vault policy)
# ============================================================================
azureKeyVault:
  enabled: true
  vaultName: "wM-kv"
  tenantId: "6824e2ad-c1e1-4119-912d-c1f42857e416"
  clientId: "b5ed39af-9682-4049-b8a8-c013f5bfc395"  # Azure Key Vault Secrets Provider identity Client ID (webmethods-cluster)
  mountPath: "/mnt/secrets-store"

  # Environment-specific prefix for secret names in Azure Key Vault
  # Secrets will be retrieved as: {secretKeyPrefix}-{secretName}
  # Example: dev-jdbc-pool-password, dev-keystore-password, dev-um-password
  secretKeyPrefix: "dev"

  # KEYSTORE Certificates (Certificate + Private Key)
  # These certificates represent YOUR server's identity
  # Upload to Azure Key Vault as Certificate with private key (PKCS12/PFX)
  # Passwords stored in Azure Key Vault: dev-keystore-password, dev-keyalias-password
  certificates:
    - certName: "wm-cer"
      fileName: "wm_keystore.p12"
      keystoreConfig:
        aliasName: "WM_KEYSTORE"
        description: "webMethods Keystore from Azure Key Vault (Dev)"
        type: "PKCS12"
        provider: "SUN"
        # Password injected via environment variable from Azure Key Vault
        isHsm: false
        keys:
          - keyAliasName: "wm-cer"
            # Key alias password injected via environment variable from Azure Key Vault

  # Additional secrets can be stored here (not commonly used)
  secrets: []

# ============================================================================
# TRUSTSTORE Configuration
# ============================================================================
# Truststore contains trusted certificates (CA certs, partner certs)
# Each certificate should be uploaded to Azure Key Vault as Certificate object
# WITHOUT private key (just the .crt file)
#
# How it works:
# 1. Upload trusted CA certificates to Azure Key Vault (Certificate section)
# 2. List them below in the certificates array
# 3. Init container fetches all certificates from Key Vault
# 4. Init container combines them into single PKCS12 truststore with --legacy flag
# 5. MSR loads the truststore
#
# Example: Upload a trusted CA certificate
#   az keyvault certificate import \
#     --vault-name wM-kv \
#     --name truststore-root-ca \
#     --file root-ca.crt
# ============================================================================
truststoreCertificates:
  enabled: true
  fileName: "wm_truststore.p12"
  aliasName: "WM_TRUSTSTORE"
  description: "webMethods Truststore from Azure Key Vault (Dev)"
  type: "PKCS12"
  provider: "SUN"
  # Password stored in Azure Key Vault: dev-truststore-password
  # Password injected via environment variable from Azure Key Vault

  # List of trusted certificates to include in truststore
  # Each certificate must exist in Azure Key Vault (Secrets section as PEM files)
  # These certificates are public certificates only (no private keys)
  # Certificate names in Key Vault are prefixed with secretKeyPrefix: dev-truststore-root-ca, etc.
  certificates:
    - certName: "truststore-root-ca"          # Root CA certificate (Key Vault: dev-truststore-root-ca)
      alias: "root-ca"                        # Alias in PKCS12 truststore
    - certName: "truststore-intermediate-ca"  # Intermediate CA certificate (Key Vault: dev-truststore-intermediate-ca)
      alias: "intermediate-ca"
    - certName: "truststore-partner-cert"     # Partner's public certificate (Key Vault: dev-truststore-partner-cert)
      alias: "partner-cert"
    - certName: "truststore-payment-gateway"  # Payment Gateway partner certificate (Key Vault: dev-truststore-payment-gateway)
      alias: "payment-gateway"
    - certName: "truststore-banking-partner"  # Banking partner certificate (Key Vault: dev-truststore-banking-partner)
      alias: "banking-partner"

# ============================================================================
# PACKAGE CONFIGURATIONS (Environment-Specific app.properties)
# ============================================================================
# This section allows you to define environment-specific app.properties for
# each custom package. These configurations are mounted at runtime via ConfigMap,
# following the 12-Factor App principle of separating config from code.
#
# Benefits:
# - Single Docker image for all environments
# - Config changes without rebuilding image
# - GitOps-friendly (values files are source of truth)
# - Easy rollback via Helm
#
# For sensitive values (API keys, passwords):
# - Store in Azure Key Vault
# - Reference using ${ENV_VAR} syntax
# - Add corresponding secrets to secretproviderclass.yaml
#
# Example usage:
#   packageConfigs:
#     enabled: true
#     packages:
#       - name: MyPackage
#         appProperties: |
#           api.url=https://dev-api.example.com
#           api.key=${MY_PACKAGE_API_KEY}
# ============================================================================
packageConfigs:
  enabled: true
  packages:
    # -------------------------------------------------------------------------
    # AbTest Package Configuration - Development Environment
    # -------------------------------------------------------------------------
    - name: AbTest
      appProperties: |
        # API Configuration - Dev Environment
        apibaseurl=https://api-dev.demo.com/v1
        apiKey=${ABTEST_API_KEY}

        # Agency/Program IDs - Dev
        agencyId=U5555555555555555-DEV-AB
        programId=8555555555555555-DEV-AB

        # XML Namespace
        xmlns=http://www.pj.com/api/v1/

        # Form/Field IDs - Dev Environment
        projectChecklistFormId=8555555555555-DEV-AB
        singleLineAttachmentId=15555555555555-DEV-AB
        meterNumberDataFieldId=U4444444444444-DEV-AB
        meterSetDateDataFieldId=G444444444444-DEV-AB
        revisedSiteDiagramAttachmentId=ERRRRRRRRRRRRR-DEV-AB
        siteDiagramAttachmentId=9EEEEEEEEEEE-DEV-AB
        hostCustomerSectorFieldId=4DDDDDDDDDDDDDD-DEV-AB
        inspectionFormId=FFFFFFFFFF-DEV-AB
        ahjFormId=FFFFFFFFFF-DEV-AB
        applicationFormId=GGGGGGGG-DEV-AB

        # File Paths - Dev Environment
        attachmentFilePath=/dev/smud456Single Line Drawings
        projectsFilePath=/dev/smud456/ProjectsExport
        siteDiagramFilePath=/dev/smud123/Site Drawings

        # Security Config
        hashAlgorithm=HmacSHA1
        TOTPReturnDigits=60

    # -------------------------------------------------------------------------
    # AbTest2 Package Configuration - Development Environment
    # -------------------------------------------------------------------------
    - name: AbTest2
      appProperties: |
        # API Configuration - Dev Environment
        apibaseurl=https://api-dev.demo.com/v1
        apiKey=${ABTEST2_API_KEY}

        # Agency/Program IDs - Dev
        agencyId=U5222222222222222-DEV
        programId=8555555555555555-DEV

        # XML Namespace
        xmlns=http://www.pj.com/api/v1/

        # Form/Field IDs - Dev Environment
        projectChecklistFormId=8555555555555-DEV
        singleLineAttachmentId=15555555555555-DEV
        meterNumberDataFieldId=U4444444444444-DEV
        meterSetDateDataFieldId=G444444444444-DEV
        revisedSiteDiagramAttachmentId=ERRRRRRRRRRRRR-DEV
        siteDiagramAttachmentId=9EEEEEEEEEEE-DEV
        hostCustomerSectorFieldId=4DDDDDDDDDDDDDD-DEV
        inspectionFormId=FFFFFFFFFF-DEV
        ahjFormId=FFFFFFFFFF-DEV
        applicationFormId=GGGGGGGG-DEV

        # File Paths - Dev Environment
        attachmentFilePath=/dev/smud456Single Line Drawings
        projectsFilePath=/dev/smud456/ProjectsExport
        siteDiagramFilePath=/dev/smud123/Site Drawings

        # Security Config
        hashAlgorithm=HmacSHA1
        TOTPReturnDigits=60

    # -------------------------------------------------------------------------
    # AbTest3 Package Configuration - Development Environment
    # -------------------------------------------------------------------------
    # - name: AbTest3
    #   appProperties: |
    #     # Add AbTest3 dev-specific properties here
    #     example.property=dev-value

# ============================================================================
# FILE ACCESS CONTROL Configuration (WmPublic package - pub.file services)
# ============================================================================
# Controls which directories/files the pub.file services can read, write, delete
# This creates fileAccessControl.cnf in WmPublic/config directory
#
# Path Format:
# - Use semicolons (;) to separate multiple paths (no spaces)
# - Single asterisk (*) matches directory names
# - Double asterisk (**) matches multiple nested folders and files
# - Paths are case-sensitive on Linux
#
# Reference: https://www.ibm.com/docs/en/webmethods-integration/wm-integration-server/10.15.0?topic=guide-file-folder
# ============================================================================
fileAccessControl:
  enabled: true

  # Directories/files with READ permission for pub.file services
  # Dev environment: Allow reading from temp, logs, config, and data directories
  allowedReadPaths: "/tmp;/opt/softwareag/IntegrationServer/instances/default/logs/**;/opt/softwareag/IntegrationServer/instances/default/config/**;/opt/softwareag/IntegrationServer/instances/default/data/**;/dev/smud456/**;/dev/smud123/**"

  # Directories/files with WRITE permission for pub.file services
  # Dev environment: Allow writing to temp, logs, and data directories
  allowedWritePaths: "/tmp;/opt/softwareag/IntegrationServer/instances/default/logs/**;/opt/softwareag/IntegrationServer/instances/default/data/**;/dev/smud456/**;/dev/smud123/**"

  # Directories/files with DELETE permission for pub.file services
  # Dev environment: Allow deleting from temp directory only (restrictive)
  allowedDeletePaths: "/tmp"

# ============================================================================
# webMethods Cloud (Integration Cloud) Configuration
# ============================================================================
# Enables connectivity to webMethods.io Integration / Integration Cloud
#
# Configuration files are loaded from:
#   - files/integrationlive/accounts.cnf
#   - files/integrationlive/connections.cnf
#   - files/integrationlive/applications/*.cnf
#
# Password stored in Azure Key Vault: dev-wmcloud-dev-io-password
# ============================================================================
webMethodsCloud:
  enabled: false

  # Cloud Passwords (Azure Key Vault)
  # Only enable passwords for accounts that are enabled in accounts.cnf
  cloudPasswords:
    - alias: "Dev io"
      secretName: "wmcloud-dev-io-password"
      envVar: "WMCLOUD_DEV_IO_PASSWORD"

  # Optional: Override application files from values (normally loaded from files/)
  applicationFiles: {}
