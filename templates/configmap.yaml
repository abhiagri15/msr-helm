apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "webmethods-msr.fullname" . }}-config
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "webmethods-msr.labels" . | nindent 4 }}
data:
  application.properties: |
    # ========================================================================
    # General IS watt.* Logging Configuration
    # ========================================================================
    # General IS Debug Level (Off, Fatal, Error, Warn, Info, Debug, Trace)
    # Configurable via values.yaml: logging.level
    watt.debug.level={{ .Values.logging.level | default "Info" }}

    # Enable verbose server logging
    watt.server.verbose={{ .Values.logging.verbose | default false }}

    # Enable service audit logging
    watt.server.audit.log={{ .Values.logging.auditLog | default false }}

    # Enable detailed thread logging
    watt.server.threadDump={{ .Values.logging.threadDump | default false }}

    {{- if .Values.logging.jdbc.enabled }}
    # JDBC Logging Configuration
    watt.debug.jdbc=true
    watt.server.jdbcLogLevel={{ .Values.logging.jdbc.level | default "Info" }}
    {{- end }}

    {{- if .Values.logging.sap.facilities }}
    # Facility-specific logging (format: facility:level)
    watt.debug2.facList={{ .Values.logging.sap.facilities }}
    {{- end }}

    # ========================================================================
    # SAP Adapter Configuration
    # ========================================================================
    # SAP SNC Library Path Configuration
    # This property tells the WmSAP adapter where to find the SAP Cryptographic Library
    watt.sap.snclibpath=/opt/softwareag/sap/snc/sap_crypto/libsapcrypto.so

    # SAP Adapter Logging Configuration
    # Levels: 0=Off, 1=Fatal, 2=Error, 3=Warn, 4=Info, 5=Debug, 6=Trace
    sap.adapter.logLevel={{ .Values.logging.sap.level | default 4 }}
    sap.adapter.logFacilities=all

    # SAP JCo Trace Configuration
    # jco.client.trace: 0=off, 1=on
    {{- if gt (int .Values.logging.sap.jcoTraceLevel) 0 }}
    jco.client.trace=1
    {{- else }}
    jco.client.trace=0
    {{- end }}
    # JCo trace level (0-10, where 0=off, 10=most verbose)
    jco.trace_level={{ .Values.logging.sap.jcoTraceLevel | default 0 }}
    jco.trace_path={{ .Values.logging.sap.jcoTracePath | default "/opt/softwareag/IntegrationServer/instances/default/logs" }}

    {{- if .Values.logging.spring.enabled }}
    # ========================================================================
    # Spring Boot / SLF4J Logging Configuration
    # ========================================================================
    logging.level.root={{ .Values.logging.spring.rootLevel | default "INFO" }}
    logging.level.com.wm={{ .Values.logging.spring.components.wm | default "INFO" }}
    logging.level.com.softwareag={{ .Values.logging.spring.components.softwareag | default "INFO" }}
    logging.level.com.wm.app={{ .Values.logging.spring.components.wm | default "INFO" }}
    logging.level.com.wm.pkg={{ .Values.logging.spring.components.wm | default "INFO" }}
    logging.level.com.wm.app.b2b={{ .Values.logging.spring.components.wm | default "INFO" }}
    logging.level.com.wm.app.b2b.server={{ .Values.logging.spring.components.wm | default "INFO" }}
    logging.level.com.wm.adapter.sap={{ .Values.logging.spring.components.sapAdapter | default "INFO" }}
    logging.level.com.sap.conn.jco={{ .Values.logging.spring.components.jco | default "INFO" }}
    {{- end }}

    # ========================================================================
    # File Access Control Configuration (WmPublic package)
    # ========================================================================
    # NOTE: File access control for pub.file services is configured via
    # fileAccessControl.cnf file mounted at WmPublic/config/fileAccessControl.cnf
    # See values.yaml: fileAccessControl.enabled, allowedReadPaths, allowedWritePaths, allowedDeletePaths
    # Reference: https://www.ibm.com/docs/en/webmethods-integration/wm-integration-server/10.15.0?topic=guide-file-folder

    {{- if .Values.jdbcAdapter.enabled }}
    # ========================================================================
    # JDBC Adapter Package Auto-Enable Configuration
    # ========================================================================
    # Enable WmJDBCAdapter package automatically on startup
    watt.server.packages.WmJDBCAdapter.enabled=true

    # ========================================================================
    # Disable Legacy JDBC Connections (hardcoded in package)
    # ========================================================================
    # Disable old jdbc connection baked into AbTest package image
    artConnection.AbTest.AbTest.jdbc.connectionEnabled=false

    # ========================================================================
    # JDBC Adapter Connection Configuration (artConnection)
    # ========================================================================
    # ART Connection properties for JDBC Adapter connections
    # Username from values file, password from Azure Key Vault
    # Reference: https://jahntech.com/resources/blog/update-connection-details-for-jdbc-adapter-on-webmethods-integration-server/
    {{- range .Values.jdbcAdapter.connections }}
    # Connection: {{ .packageName }}.{{ .folderName }}.{{ .name }}
    artConnection.{{ .packageName }}.{{ .folderName }}.{{ .name }}.connectionEnabled=true
    artConnection.{{ .packageName }}.{{ .folderName }}.{{ .name }}.connectionSettings.serverName={{ .serverName }}
    artConnection.{{ .packageName }}.{{ .folderName }}.{{ .name }}.connectionSettings.databaseName={{ .databaseName }}
    artConnection.{{ .packageName }}.{{ .folderName }}.{{ .name }}.connectionSettings.portNumber={{ .portNumber }}
    artConnection.{{ .packageName }}.{{ .folderName }}.{{ .name }}.connectionSettings.networkProtocol={{ .networkProtocol }}
    artConnection.{{ .packageName }}.{{ .folderName }}.{{ .name }}.connectionSettings.user={{ .username }}
    artConnection.{{ .packageName }}.{{ .folderName }}.{{ .name }}.connectionSettings.password=$env{ {{- .passwordEnvVar -}} }
    artConnection.{{ .packageName }}.{{ .folderName }}.{{ .name }}.connectionSettings.datasourceClass={{ .dataSourceClass }}
    artConnection.{{ .packageName }}.{{ .folderName }}.{{ .name }}.connectionSettings.otherProperties={{ .otherProperties }}
    artConnection.{{ .packageName }}.{{ .folderName }}.{{ .name }}.connectionManagerSettings.minimumPoolSize={{ .minPoolSize }}
    artConnection.{{ .packageName }}.{{ .folderName }}.{{ .name }}.connectionManagerSettings.maximumPoolSize={{ .maxPoolSize }}
    artConnection.{{ .packageName }}.{{ .folderName }}.{{ .name }}.connectionManagerSettings.poolIncrementSize={{ .poolIncrementSize }}
    artConnection.{{ .packageName }}.{{ .folderName }}.{{ .name }}.connectionManagerSettings.blockingTimeout={{ .blockTimeout }}
    artConnection.{{ .packageName }}.{{ .folderName }}.{{ .name }}.connectionManagerSettings.expireTimeout={{ .expireTimeout }}
    artConnection.{{ .packageName }}.{{ .folderName }}.{{ .name }}.connectionManagerSettings.startupRetryCount={{ .startupRetryCount }}
    artConnection.{{ .packageName }}.{{ .folderName }}.{{ .name }}.connectionManagerSettings.startupBackoffSecs={{ .startupBackoffSecs }}
    artConnection.{{ .packageName }}.{{ .folderName }}.{{ .name }}.connectionManagerSettings.poolable=true
    {{- end }}
    {{- end }}

    {{- if and .Values.sapAdapter .Values.sapAdapter.enabled }}
    # ========================================================================
    # SAP Adapter Package Auto-Enable Configuration
    # ========================================================================
    # Enable WmSAP package automatically on startup
    watt.server.packages.WmSAP.enabled=true

    # ========================================================================
    # SAP Adapter Connection Configuration (artConnection)
    # ========================================================================
    # ART Connection properties for SAP Adapter RFC connections
    # Format: artConnection.<packageName>.<folderName>.<connectionName>.<property>
    {{- range .Values.sapAdapter.connections }}
    # SAP Connection: {{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionEnabled={{ .enabled }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionSettings.alias={{ .alias }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionSettings.appServerHost={{ .appServerHost }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionSettings.client={{ .client }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionSettings.systemId={{ .systemId }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionSettings.systemNumber={{ .systemNumber }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionSettings.language={{ .language }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionSettings.loadBalancing={{ .loadBalancing }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionSettings.messageServerHost={{ .messageServerHost }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionSettings.logonGroup={{ .logonGroup }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionSettings.gatewayHost={{ .gatewayHost }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionSettings.gatewayService={{ .gatewayService }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionSettings.user={{ .username }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionSettings.password=$env{ {{- .passwordEnvVar -}} }
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionSettings.sncMode={{ .sncMode }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionSettings.sncMyName={{ .sncMyName }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionSettings.sncPartnerName={{ .sncPartnerName }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionSettings.sncQualityOfService={{ .sncQualityOfService }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionSettings.sncAuthentication={{ .sncAuthentication }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionSettings.connectionType={{ .connectionType }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionSettings.abapDebug={{ .abapDebug }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionSettings.rfcTrace={{ .rfcTrace }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionSettings.sapGui={{ .sapGui }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionSettings.logTransactionStatus={{ .logTransactionStatus }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionSettings.storeMsgBody={{ .storeMsgBody }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionSettings.repositoryServer={{ .repositoryServer }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionSettings.programId={{ .programId }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionSettings.routerString={{ .routerString }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionManagerSettings.minimumPoolSize={{ .minPoolSize }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionManagerSettings.maximumPoolSize={{ .maxPoolSize }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionManagerSettings.poolIncrementSize={{ .poolIncrementSize }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionManagerSettings.blockingTimeout={{ .blockTimeout }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionManagerSettings.expireTimeout={{ .expireTimeout }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionManagerSettings.startupRetryCount={{ .startupRetryCount }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionManagerSettings.startupBackoffSecs={{ .startupBackoffSecs }}
    artConnection.{{ $.Values.sapAdapter.connectionPackageName }}.{{ $.Values.sapAdapter.connectionFolderName }}.{{ .name }}.connectionManagerSettings.poolable=true
    {{- end }}

    # ========================================================================
    # SAP Adapter Listener Configuration (artListener)
    # ========================================================================
    # ART Listener properties for SAP Adapter RFC listeners (inbound from SAP)
    # Format: artListener.<packageName>.<folderName>.<listenerName>.<property>
    {{- range .Values.sapAdapter.listeners }}
    # SAP Listener: {{ $.Values.sapAdapter.listenerPackageName }}.{{ $.Values.sapAdapter.listenerFolderName }}.{{ .name }}
    artListener.{{ $.Values.sapAdapter.listenerPackageName }}.{{ $.Values.sapAdapter.listenerFolderName }}.{{ .name }}.listenerEnabled={{ .enabled }}
    artListener.{{ $.Values.sapAdapter.listenerPackageName }}.{{ $.Values.sapAdapter.listenerFolderName }}.{{ .name }}.listenerSettings.gatewayHost={{ .gatewayHost }}
    artListener.{{ $.Values.sapAdapter.listenerPackageName }}.{{ $.Values.sapAdapter.listenerFolderName }}.{{ .name }}.listenerSettings.gatewayService={{ .gatewayService }}
    artListener.{{ $.Values.sapAdapter.listenerPackageName }}.{{ $.Values.sapAdapter.listenerFolderName }}.{{ .name }}.listenerSettings.programId={{ .programId }}
    artListener.{{ $.Values.sapAdapter.listenerPackageName }}.{{ $.Values.sapAdapter.listenerFolderName }}.{{ .name }}.listenerSettings.repositoryServer={{ .repositoryServer }}
    artListener.{{ $.Values.sapAdapter.listenerPackageName }}.{{ $.Values.sapAdapter.listenerFolderName }}.{{ .name }}.listenerSettings.threadCount={{ .threadCount }}
    artListener.{{ $.Values.sapAdapter.listenerPackageName }}.{{ $.Values.sapAdapter.listenerFolderName }}.{{ .name }}.listenerSettings.unicode={{ .unicode }}
    artListener.{{ $.Values.sapAdapter.listenerPackageName }}.{{ $.Values.sapAdapter.listenerFolderName }}.{{ .name }}.listenerSettings.sncMode={{ .sncMode }}
    artListener.{{ $.Values.sapAdapter.listenerPackageName }}.{{ $.Values.sapAdapter.listenerFolderName }}.{{ .name }}.listenerSettings.sncMyName={{ .sncMyName }}
    artListener.{{ $.Values.sapAdapter.listenerPackageName }}.{{ $.Values.sapAdapter.listenerFolderName }}.{{ .name }}.listenerSettings.sncQualityOfService={{ .sncQualityOfService }}
    artListener.{{ $.Values.sapAdapter.listenerPackageName }}.{{ $.Values.sapAdapter.listenerFolderName }}.{{ .name }}.listenerSettings.rfcTrace={{ .rfcTrace }}
    artListener.{{ $.Values.sapAdapter.listenerPackageName }}.{{ $.Values.sapAdapter.listenerFolderName }}.{{ .name }}.listenerSettings.logTransactionStatus={{ .logTransactionStatus }}
    artListener.{{ $.Values.sapAdapter.listenerPackageName }}.{{ $.Values.sapAdapter.listenerFolderName }}.{{ .name }}.listenerSettings.storeMsgBody={{ .storeMsgBody }}
    artListener.{{ $.Values.sapAdapter.listenerPackageName }}.{{ $.Values.sapAdapter.listenerFolderName }}.{{ .name }}.listenerSettings.authService={{ .authService }}
    artListener.{{ $.Values.sapAdapter.listenerPackageName }}.{{ $.Values.sapAdapter.listenerFolderName }}.{{ .name }}.retryLimit={{ .retryLimit }}
    artListener.{{ $.Values.sapAdapter.listenerPackageName }}.{{ $.Values.sapAdapter.listenerFolderName }}.{{ .name }}.retryBackoffTimeout={{ .retryBackoffTimeout }}
    {{- end }}
    {{- end }}

    {{- if .Values.jdbcPool.enabled }}
    # ========================================================================
    # JDBC POOL Configuration (Multiple Pools Supported)
    # ========================================================================
    # Each pool has URL and username in values file, password from Azure Key Vault
    {{- range .Values.jdbcPool.pools }}
    # Pool: {{ .name }}
    jdbc.{{ .name }}.dbURL={{ .dbURL }}
    jdbc.{{ .name }}.description={{ .description | default "JDBC Pool" }}
    jdbc.{{ .name }}.driverAlias={{ .driverAlias }}
    jdbc.{{ .name }}.dataSourceClass={{ .dataSourceClass }}
    jdbc.{{ .name }}.expireTime={{ .expireTime | default 60000 }}
    jdbc.{{ .name }}.keystoreAlias=
    jdbc.{{ .name }}.maxConns={{ .maxConns | default 100 }}
    jdbc.{{ .name }}.minConns={{ .minConns | default 1 }}
    jdbc.{{ .name }}.password=$env{ {{- .passwordEnvVar -}} }
    jdbc.{{ .name }}.poolThreshold={{ .poolThreshold | default 5 }}
    jdbc.{{ .name }}.snoopenabled=false
    jdbc.{{ .name }}.snoopparms=ddtdbg.ProtocolTraceEnable=true;ddtdbg.ProtocolTraceMaxline=16;ddtdbg.ProtocolTraceLocation=logs/snoop/{{ .name }}.log;ddtdbg.ProtocolTraceShowTime=true
    jdbc.{{ .name }}.spyenabled=false
    jdbc.{{ .name }}.spyparms=SpyAttributes=(log=(file)logs/spy/{{ .name }}.log;logTName=yes;timestamp=yes)
    jdbc.{{ .name }}.tlsVersion=
    jdbc.{{ .name }}.truststoreAlias=
    jdbc.{{ .name }}.useSSL={{ .useSSL | default false }}
    jdbc.{{ .name }}.userid={{ .username }}
    jdbc.{{ .name }}.waitingThread={{ .waitingThread | default 50 }}
    {{- end }}

    # JDBC Functional Aliases
    {{- range .Values.jdbcPool.functionalAliases }}
    jdbcfunc.{{ .name }}.connPoolAlias={{ .connPoolAlias }}
    jdbcfunc.{{ .name }}.failFastMode={{ .failFastMode }}
    {{- end }}
    {{- end }}

    {{- if .Values.um.enabled }}
    # Universal Messaging Connection Aliases
    # Passwords injected via environment variables from Azure Key Vault
    {{- range .Values.um.connections }}
    messaging.{{ .connectionAlias }}.enabled={{ .connectionEnabled }}
    messaging.{{ .connectionAlias }}.url={{ .url }}
    messaging.{{ .connectionAlias }}.user={{ .user }}
    messaging.{{ .connectionAlias }}.password=$env{ {{- .passwordEnvVar -}} }
    messaging.{{ .connectionAlias }}.useCSQ={{ .useCSQ }}
    messaging.{{ .connectionAlias }}.csqSize={{ .csqSize }}
    messaging.{{ .connectionAlias }}.csqDrainInOrder={{ .csqDrainInOrder }}
    {{- end }}
    {{- end }}

    {{- if .Values.terracotta.enabled }}
    # Terracotta Cache Manager Configuration
    cachemanager.{{ .Values.terracotta.cacheManagerName }}.urls={{ join "," .Values.terracotta.urls }}
    {{- end }}

    {{- range .Values.keystores }}
    # Keystore Configuration - {{ .aliasName }}
    keystore.{{ .aliasName }}.ksDescription={{ .description }}
    keystore.{{ .aliasName }}.ksType={{ .type }}
    keystore.{{ .aliasName }}.ksStoreProviderName={{ .provider }}
    keystore.{{ .aliasName }}.ksLocation={{ .location }}
    keystore.{{ .aliasName }}.ksPassword={{ .password }}
    keystore.{{ .aliasName }}.ksIsHsm={{ .isHsm }}
    {{- range .keys }}
    keystore.{{ $.aliasName }}.keyAlias.{{ .keyAliasName }}.keyAliasPassword={{ .keyAliasPassword }}
    {{- end }}
    {{- end }}

    {{- range .Values.truststores }}
    # Truststore Configuration - {{ .aliasName }}
    truststore.{{ .aliasName }}.ksDescription={{ .description }}
    truststore.{{ .aliasName }}.ksType={{ .type }}
    truststore.{{ .aliasName }}.ksStoreProviderName={{ .provider }}
    truststore.{{ .aliasName }}.ksLocation={{ .location }}
    truststore.{{ .aliasName }}.ksPassword={{ .password }}
    {{- end }}

    {{- if .Values.azureKeyVault.enabled }}
    {{- range $cert := .Values.azureKeyVault.certificates }}
    {{- if $cert.keystoreConfig }}
    # Keystore Configuration from Azure Key Vault - {{ $cert.keystoreConfig.aliasName }}
    # Passwords injected via environment variables from Azure Key Vault
    keystore.{{ $cert.keystoreConfig.aliasName }}.ksDescription={{ $cert.keystoreConfig.description }}
    keystore.{{ $cert.keystoreConfig.aliasName }}.ksType={{ $cert.keystoreConfig.type }}
    keystore.{{ $cert.keystoreConfig.aliasName }}.ksStoreProviderName={{ $cert.keystoreConfig.provider }}
    keystore.{{ $cert.keystoreConfig.aliasName }}.ksLocation=/opt/softwareag/IntegrationServer/instances/default/config/kv-keystores/{{ $cert.fileName }}
    keystore.{{ $cert.keystoreConfig.aliasName }}.ksPassword=$env{KEYSTORE_PASSWORD}
    keystore.{{ $cert.keystoreConfig.aliasName }}.ksIsHsm={{ $cert.keystoreConfig.isHsm }}
    {{- range $cert.keystoreConfig.keys }}
    keystore.{{ $cert.keystoreConfig.aliasName }}.keyAlias.{{ .keyAliasName }}.keyAliasPassword=$env{KEYALIAS_PASSWORD}
    {{- end }}
    {{- end }}
    {{- end }}
    {{- range $secret := .Values.azureKeyVault.secrets }}
    {{- if $secret.truststoreConfig }}
    # Truststore Configuration from Azure Key Vault - {{ $secret.truststoreConfig.aliasName }}
    # Password injected via environment variable from Azure Key Vault
    truststore.{{ $secret.truststoreConfig.aliasName }}.ksDescription={{ $secret.truststoreConfig.description }}
    truststore.{{ $secret.truststoreConfig.aliasName }}.ksType={{ $secret.truststoreConfig.type }}
    truststore.{{ $secret.truststoreConfig.aliasName }}.ksStoreProviderName={{ $secret.truststoreConfig.provider }}
    truststore.{{ $secret.truststoreConfig.aliasName }}.ksLocation=/opt/softwareag/IntegrationServer/instances/default/config/kv-keystores/{{ $secret.fileName }}
    truststore.{{ $secret.truststoreConfig.aliasName }}.ksPassword=$env{TRUSTSTORE_PASSWORD}
    {{- end }}
    {{- end }}
    {{- end}}
    {{- if .Values.truststoreCertificates.enabled }}

    # Truststore Configuration from Azure Key Vault - {{ .Values.truststoreCertificates.aliasName }}
    # Password injected via environment variable from Azure Key Vault
    truststore.{{ .Values.truststoreCertificates.aliasName }}.ksDescription={{ .Values.truststoreCertificates.description }}
    truststore.{{ .Values.truststoreCertificates.aliasName }}.ksType={{ .Values.truststoreCertificates.type }}
    truststore.{{ .Values.truststoreCertificates.aliasName }}.ksStoreProviderName={{ .Values.truststoreCertificates.provider }}
    truststore.{{ .Values.truststoreCertificates.aliasName }}.ksLocation=/opt/softwareag/IntegrationServer/instances/default/config/kv-keystores/{{ .Values.truststoreCertificates.fileName }}
    truststore.{{ .Values.truststoreCertificates.aliasName }}.ksPassword=$env{TRUSTSTORE_PASSWORD}
    {{- end }}
  # ============================================================================
  # server.cnf - Server Configuration Properties
  # ============================================================================
  # Properties in server.cnf are loaded at Integration Server startup
  # SAP SNC library path MUST be in server.cnf for WmSAP adapter to recognize it
  # Logging levels are configurable via values.yaml: logging.level, logging.sap.*
  server.cnf: |
    # SAP SNC Library Path Configuration
    # This property tells the WmSAP adapter where to find the SAP Cryptographic Library
    watt.sap.snclibpath=/opt/softwareag/sap/snc/sap_crypto/libsapcrypto.so

    # ============================================================================
    # SAP Adapter Logging Configuration
    # ============================================================================
    # Adapter logging facility settings (0=Off, 1=Fatal, 2=Error, 3=Warn, 4=Info, 5=Debug, 6=Trace)
    # Configurable via values.yaml: logging.sap.level
    watt.adapter.WmSAP.debuglevel={{ .Values.logging.sap.level | default 4 }}
    watt.adapter.WmSAP.defaultLogLevel={{ .Values.logging.sap.level | default 4 }}

    # SAP JCo trace settings
    # jco.trace_level: 0-10 (0=off, 10=most verbose)
    # Configurable via values.yaml: logging.sap.jcoTraceLevel
    jco.trace_level={{ .Values.logging.sap.jcoTraceLevel | default 0 }}
    jco.trace_path={{ .Values.logging.sap.jcoTracePath | default "/opt/softwareag/IntegrationServer/instances/default/logs" }}

    # Enable verbose adapter connection logging
    watt.sap.aclset=true
    watt.sap.listener.checkTime=1

    # ============================================================================
    # General IS Debug/Logging Settings
    # ============================================================================
    # Debug levels: Off, Fatal, Error, Warn, Info, Debug, Trace
    # Configurable via values.yaml: logging.level
    watt.debug.level={{ .Values.logging.level | default "Info" }}

    {{- if .Values.logging.sap.facilities }}
    # Facility-specific logging (format: facility:level)
    # Levels: 0=Off, 1=Fatal, 2=Error, 3=Warn, 4=Info, 5=Debug, 6=Trace
    watt.debug2.facList={{ .Values.logging.sap.facilities }}
    {{- end }}

    # Enable verbose server logging
    # Configurable via values.yaml: logging.verbose
    watt.server.verbose={{ .Values.logging.verbose | default false }}

    # Log all service invocations
    # Configurable via values.yaml: logging.auditLog
    watt.server.audit.log={{ .Values.logging.auditLog | default false }}

    # Enable detailed thread logging
    # Configurable via values.yaml: logging.threadDump
    watt.server.threadDump={{ .Values.logging.threadDump | default false }}
---
{{- if .Values.terracotta.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "webmethods-msr.fullname" . }}-terracotta-xml
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "webmethods-msr.labels" . | nindent 4 }}
data:
  IS_TERRACOTTA_CACHE.xml: |
    <ehcache name="{{ .Values.terracotta.cacheManagerName }}">
        <diskStore path="./cacheStore/{{ .Values.terracotta.cacheManagerName }}"/>
        <defaultCache/>
        <terracottaConfig
            url="{{ join "," .Values.terracotta.urls }}"
            rejoin="true"/>
    </ehcache>
{{- end }}
---
{{- if .Values.jdbcAdapter.enabled }}
# ============================================================================
# JDBC Adapter Connection ConfigMap
# ============================================================================
# This ConfigMap contains the JDBC adapter connection configuration
# It will be mounted and processed by an init container to create node.ndf files
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "webmethods-msr.fullname" . }}-jdbc-adapter
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "webmethods-msr.labels" . | nindent 4 }}
data:
  {{- range .Values.jdbcAdapter.connections }}
  {{ .name }}.yaml: |
    # JDBC Adapter Connection: {{ .name }}
    # Credentials injected via environment variables from Azure Key Vault
    name: {{ .name }}
    description: {{ .description }}
    packageName: {{ .packageName }}
    connectionType: {{ .connectionType }}
    connectionFactoryInterface: {{ .connectionFactoryInterface }}
    transactionType: {{ .transactionType }}
    connectionSettings:
      driverType: DataDirect Connect JDBC Driver
      serverName: ${JDBC_ADAPTER_SERVER}
      databaseName: ${JDBC_ADAPTER_DATABASE}
      portNumber: ${JDBC_ADAPTER_PORT}
      user: ${JDBC_ADAPTER_USERNAME}
      password: ${JDBC_ADAPTER_PASSWORD}
      otherProperties: encrypt=true
      networkProtocol: ""
    poolConfig:
      minimumPoolSize: {{ .minPoolSize }}
      maximumPoolSize: {{ .maxPoolSize }}
      poolIncrementSize: {{ .poolIncrementSize }}
      blockTimeout: {{ .blockTimeout }}
      expireTimeout: {{ .expireTimeout }}
      startupRetryCount: {{ .startupRetryCount }}
      startupBackoffSecs: {{ .startupBackoffSecs }}
  {{- end }}
{{- end }}
---
{{- if .Values.fileAccessControl.enabled }}
# ============================================================================
# File Access Control ConfigMap (WmPublic package - pub.file services)
# ============================================================================
# This ConfigMap creates the fileAccessControl.cnf file that controls
# which directories/files the pub.file services can read, write, and delete.
#
# File location: WmPublic/config/fileAccessControl.cnf
# Reference: https://www.ibm.com/docs/en/webmethods-integration/wm-integration-server/10.15.0?topic=guide-file-folder
# ============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "webmethods-msr.fullname" . }}-file-access-control
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "webmethods-msr.labels" . | nindent 4 }}
data:
  fileAccessControl.cnf: |
    # ========================================================================
    # File Access Control Configuration for WmPublic pub.file Services
    # ========================================================================
    # This file controls which directories and files the pub.file services
    # (pub.file:getFile, pub.file:saveFile, pub.file:deleteFile, etc.) can access.
    #
    # Path Format:
    # - Use semicolons (;) to separate multiple paths (no spaces between entries)
    # - Single asterisk (*) matches single directory level
    # - Double asterisk (**) matches multiple nested folders and files
    # - Paths are case-sensitive on Linux
    # - If path contains semicolons, precede them with double backslashes (\\)
    #
    # Changes require WmPublic package reload or Integration Server restart
    # ========================================================================

    # Directories/files with READ permission
    allowedReadPaths={{ .Values.fileAccessControl.allowedReadPaths }}

    # Directories/files with WRITE permission
    allowedWritePaths={{ .Values.fileAccessControl.allowedWritePaths }}

    # Directories/files with DELETE permission
    allowedDeletePaths={{ .Values.fileAccessControl.allowedDeletePaths }}
{{- end }}
---
# ============================================================================
# ACL Map ConfigMap (aclmap_sm.cnf - Service ACL Mappings)
# ============================================================================
# This ConfigMap creates the aclmap_sm.cnf file that maps services to ACLs.
# Services listed here will have their ACLs set accordingly.
#
# File location: /opt/softwareag/IntegrationServer/instances/default/config/aclmap_sm.cnf
# ============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "webmethods-msr.fullname" . }}-aclmap
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "webmethods-msr.labels" . | nindent 4 }}
data:
  aclmap_sm.cnf: |
{{ .Files.Get (printf "files/%s/config/aclmap_sm.cnf" .Values.environment) | indent 4 }}
---
{{- if .Values.caching.publicCacheManagers.enabled }}
# ============================================================================
# Public Cache Managers ConfigMap
# ============================================================================
# Ehcache XML files for public cache managers loaded from files/{environment}/config/caching/
# Each XML file defines a cache manager with its caches.
# Drop new XML files into files/{environment}/config/caching/ and they will be auto-discovered.
#
# Mount location: /opt/softwareag/IntegrationServer/config/Caching/
# ============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "webmethods-msr.fullname" . }}-public-caches
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "webmethods-msr.labels" . | nindent 4 }}
data:
  {{- $cacheFiles := .Files.Glob (printf "files/%s/config/caching/*.xml" .Values.environment) }}
  {{- range $path, $content := $cacheFiles }}
  {{ base $path }}: |
{{ $.Files.Get $path | indent 4 }}
  {{- end }}
{{- end }}
---
{{- if and .Values.license.enabled .Values.environment }}
# ============================================================================
# License Key ConfigMap
# ============================================================================
# Environment-specific licenseKey.xml loaded from files/{environment}/license/
# Mounted at /opt/softwareag/IntegrationServer/instances/default/config/licenseKey.xml
# ============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "webmethods-msr.fullname" . }}-license
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "webmethods-msr.labels" . | nindent 4 }}
data:
  licenseKey.xml: |
{{ .Files.Get (printf "files/%s/license/licenseKey.xml" .Values.environment) | indent 4 }}
{{- end }}
---
{{- if and .Values.terracotta.enabled .Values.environment }}
# ============================================================================
# Terracotta Client License ConfigMap
# ============================================================================
# Environment-specific terracotta-license.key loaded from files/{environment}/license/
# Mounted at /opt/softwareag/IntegrationServer/config/terracotta-license.key
# Required for MSR to use Terracotta BigMemory features (distributed caching)
# JVM property -Dcom.tc.productkey.path is set automatically in the StatefulSet
# ============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "webmethods-msr.fullname" . }}-tc-license
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "webmethods-msr.labels" . | nindent 4 }}
data:
  terracotta-license.key: |
{{ .Files.Get (printf "files/%s/license/terracotta-license.key" .Values.environment) | indent 4 }}
{{- end }}
---
{{- if and .Values.jmsConfig.enabled .Values.environment }}
# ============================================================================
# JMS/JNDI Configuration ConfigMap
# ============================================================================
# JMS connection aliases and JNDI provider configuration for UM connectivity.
# Files loaded from files/{environment}/config/jms.cnf and jndi/jndi_JNDI.properties
# ============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "webmethods-msr.fullname" . }}-jms-config
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "webmethods-msr.labels" . | nindent 4 }}
data:
  jms.cnf: |
{{ .Files.Get (printf "files/%s/config/jms.cnf" .Values.environment) | indent 4 }}
  jndi_JNDI.properties: |
{{ .Files.Get (printf "files/%s/config/jndi/jndi_JNDI.properties" .Values.environment) | indent 4 }}
{{- end }}
---
{{- if and .Values.sapAdapter .Values.sapAdapter.snc .Values.sapAdapter.snc.externalCredentials .Values.environment }}
# ============================================================================
# SAP SNC Credentials Secret
# ============================================================================
# Environment-specific SAP SNC credentials (cred_v2 + PSE) loaded from
# files/{environment}/sap_crypto/sec/
# Mounted at /opt/softwareag/sap/snc/sap_crypto/sec (replaces baked-in files)
# ============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.sapAdapter.snc.secretName | default "sap-snc-credentials" }}
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "webmethods-msr.labels" . | nindent 4 }}
data:
  {{- $sncFiles := .Files.Glob (printf "files/%s/sap_crypto/sec/*" .Values.environment) }}
{{ ($sncFiles).AsSecrets | indent 2 }}
{{- end }}
